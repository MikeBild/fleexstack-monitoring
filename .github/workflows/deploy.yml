name: Deploy DO Functions

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      function:
        description: 'Specific function to deploy (leave empty for all)'
        required: false
        type: string
      clean_deploy:
        description: 'Delete and recreate namespace (clean deployment)'
        required: false
        type: boolean
        default: false

env:
  NAMESPACE: fleexstack-monitoring

jobs:
  deploy:
    name: Deploy Functions
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DO_API_TOKEN }}

      - name: Install serverless plugin
        run: doctl serverless install

      - name: Delete existing namespace (clean deploy)
        if: ${{ github.event.inputs.clean_deploy == 'true' }}
        run: |
          echo "Deleting namespace ${{ env.NAMESPACE }} if exists..."
          if doctl serverless namespaces list | grep -q "${{ env.NAMESPACE }}"; then
            doctl serverless namespaces delete ${{ env.NAMESPACE }} --force || true
            echo "Waiting for namespace deletion..."
            sleep 10
          fi

      - name: Create namespace (clean deploy)
        if: ${{ github.event.inputs.clean_deploy == 'true' }}
        run: |
          echo "Creating namespace ${{ env.NAMESPACE }}"
          doctl serverless namespaces create --label ${{ env.NAMESPACE }} --region fra1

      - name: Connect to namespace
        run: |
          if ! doctl serverless namespaces list | grep -q "${{ env.NAMESPACE }}"; then
            echo "Creating namespace ${{ env.NAMESPACE }}"
            doctl serverless namespaces create --label ${{ env.NAMESPACE }} --region fra1
          fi
          echo "Connecting to namespace ${{ env.NAMESPACE }}"
          doctl serverless connect ${{ env.NAMESPACE }}

      - name: Deploy functions
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          GENAI_AGENT_URL: ${{ vars.GENAI_AGENT_URL }}
          GENAI_API_KEY: ${{ secrets.GENAI_API_KEY }}
          BLUE_HOST: ${{ vars.BLUE_HOST }}
          GREEN_HOST: ${{ vars.GREEN_HOST }}
          ALERTS_REPO: ${{ vars.ALERTS_REPO }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          SPACES_ACCESS_KEY_ID: ${{ secrets.SPACES_ACCESS_KEY_ID }}
          SPACES_SECRET_ACCESS_KEY: ${{ secrets.SPACES_SECRET_ACCESS_KEY }}
        run: |
          if [ -n "${{ github.event.inputs.function }}" ]; then
            echo "Deploying: ${{ github.event.inputs.function }}"
            doctl serverless deploy . --include "packages/monitoring/${{ github.event.inputs.function }}"
          else
            echo "Deploying all functions"
            doctl serverless deploy .
          fi

      - name: Verify deployment
        run: doctl serverless functions list

      - name: Deployment summary
        if: always()
        run: |
          echo "## DO Functions Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Function | Schedule |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| collect-logs | */5 * * * * |" >> $GITHUB_STEP_SUMMARY
          echo "| analyze-logs | */15 * * * * |" >> $GITHUB_STEP_SUMMARY
          echo "| detect-issues | 5,20,35,50 * * * * |" >> $GITHUB_STEP_SUMMARY
          echo "| predict-issues | 0 * * * * |" >> $GITHUB_STEP_SUMMARY
          echo "| send-digest | 0 8 * * * |" >> $GITHUB_STEP_SUMMARY
          echo "| cleanup-data | 0 2 * * * |" >> $GITHUB_STEP_SUMMARY
